import{c as P,d as c,b as Y,h as q,m as _,r as i,j as e,C as p,i as j,k as f,f as C,l as E}from"./index-BiTP6UeF.js";import{u as J}from"./useSuspenseQuery-BI5dw9cZ.js";import{B as d}from"./button-RNOw0Kg4.js";import{I as T}from"./input-C8zM_rjF.js";import{L as $}from"./label-BUooFWRZ.js";import{B as y}from"./badge-Djmg-4jD.js";import{M as L}from"./mail-Djp8AAiC.js";import{C as K}from"./circle-check-oSI9b7XE.js";import{C as V}from"./circle-alert-c2HjJ2Ls.js";import{C as Z}from"./circle-x-CjqoQCx6.js";import{R as ee}from"./refresh-cw-aD6uxtSl.js";import{E as m}from"./external-link-DQ7xCNxh.js";import{C as se}from"./copy-BYoSSq7T.js";import"./index-eoGaCaxS.js";function pe(){const{data:t}=J(P(c.settingsStore.getGmailSettings,{})),{data:l}=Y({...P(c.gmailSync.getStats,{}),enabled:!!t?.isConfigured}),D=q(c.settingsStore.setSetting),F=_(c.gmailActions.testConnection),N=_(c.gmailActions.exchangeCodeForTokens),[x,O]=i.useState(t?.clientId??""),[h,R]=i.useState(t?.clientSecret??""),[w,b]=i.useState(!1),[v,S]=i.useState(!1),[g,o]=i.useState(null),u=t?.isConfigured??!1,I=!!(t?.clientId&&t?.clientSecret),r=typeof window<"u"?`${window.location.origin}/settings/gmail/callback`:"",U=async()=>{if(!x.trim()||!h.trim()){alert("Please enter both Client ID and Client Secret");return}b(!0);try{await D({key:"gmail",type:"oauth",value:{clientId:x.trim(),clientSecret:h.trim(),isConfigured:!1}}),alert('Credentials saved! Now click "Connect Gmail" to authorize.')}catch(s){alert(s.message||"Failed to save credentials")}finally{b(!1)}},z=i.useCallback(()=>{if(!t?.clientId){alert("Please save your Client ID first");return}const s=["https://www.googleapis.com/auth/gmail.readonly","https://www.googleapis.com/auth/gmail.labels"].join(" "),a=new URL("https://accounts.google.com/o/oauth2/v2/auth");a.searchParams.set("client_id",t.clientId),a.searchParams.set("redirect_uri",r),a.searchParams.set("response_type","code"),a.searchParams.set("scope",s),a.searchParams.set("access_type","offline"),a.searchParams.set("prompt","consent");const k=500,G=600,Q=window.screenX+(window.outerWidth-k)/2,W=window.screenY+(window.outerHeight-G)/2,X=window.open(a.toString(),"gmail_oauth",`width=${k},height=${G},left=${Q},top=${W}`),A=async n=>{if(n.origin===window.location.origin&&n.data?.type==="gmail_oauth_callback")if(window.removeEventListener("message",A),X?.close(),n.data.code)try{await N({code:n.data.code,redirectUri:r}),window.location.reload()}catch(H){alert("Failed to complete authorization: "+(H.message||"Unknown error"))}else n.data.error&&alert("Authorization failed: "+n.data.error)};window.addEventListener("message",A)},[t?.clientId,r,N]),B=async()=>{S(!0),o(null);try{const s=await F({});s.success?o({success:!0,message:`Connected! Inbox: ${s.stats?.totalInbox} emails, ${s.stats?.unread} unread`}):o({success:!1,message:s.error||"Connection failed"})}catch(s){o({success:!1,message:s.message||"Connection test failed"})}finally{S(!1)}},M=s=>{navigator.clipboard.writeText(s)};return e.jsxs("div",{className:"container mx-auto p-6 max-w-4xl",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{className:"w-8 h-8 text-red-500"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Gmail Integration"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Connect your Gmail to track inbox statistics"})]})]})}),e.jsxs(p,{className:"mb-6",children:[e.jsx(j,{children:e.jsxs(f,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Connection Status"}),u?e.jsxs(y,{className:"bg-green-100 text-green-800",children:[e.jsx(K,{className:"w-4 h-4 mr-1"}),"Connected"]}):I?e.jsxs(y,{className:"bg-yellow-100 text-yellow-800",children:[e.jsx(V,{className:"w-4 h-4 mr-1"}),"Credentials Set - Authorization Needed"]}):e.jsxs(y,{className:"bg-gray-100 text-gray-800",children:[e.jsx(Z,{className:"w-4 h-4 mr-1"}),"Not Configured"]})]})}),u&&l&&e.jsxs(C,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Current Inbox"}),e.jsx("p",{className:"text-lg font-semibold",children:l.currentInbox??"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Unread"}),e.jsx("p",{className:"text-lg font-semibold",children:l.currentUnread??"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Total Snapshots"}),e.jsx("p",{className:"text-lg font-semibold",children:l.totalSnapshots})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Last Sync"}),e.jsx("p",{className:"text-lg font-semibold",children:l.newestSnapshot?new Date(l.newestSnapshot).toLocaleString():"-"})]})]}),e.jsx("div",{className:"mt-4 flex gap-2",children:e.jsxs(d,{variant:"outline",size:"sm",onClick:B,disabled:v,children:[e.jsx(ee,{className:`w-4 h-4 mr-2 ${v?"animate-spin":""}`}),"Test Connection"]})}),g&&e.jsx("div",{className:`mt-3 p-3 rounded-lg ${g.success?"bg-green-50 text-green-800":"bg-red-50 text-red-800"}`,children:g.message})]})]}),e.jsxs(p,{className:"mb-6",children:[e.jsxs(j,{children:[e.jsx(f,{children:"Setup Instructions"}),e.jsx(E,{children:"Follow these steps to connect your Gmail account"})]}),e.jsxs(C,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx("span",{className:"w-6 h-6 rounded-full bg-blue-100 text-blue-800 flex items-center justify-center text-sm",children:"1"}),"Create a Google Cloud Project"]}),e.jsxs("div",{className:"ml-8 space-y-2 text-sm text-gray-600",children:[e.jsxs("p",{children:["Go to the"," ",e.jsxs("a",{href:"https://console.cloud.google.com/",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline inline-flex items-center gap-1",children:["Google Cloud Console ",e.jsx(m,{className:"w-3 h-3"})]})]}),e.jsx("p",{children:"Create a new project or select an existing one."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx("span",{className:"w-6 h-6 rounded-full bg-blue-100 text-blue-800 flex items-center justify-center text-sm",children:"2"}),"Enable the Gmail API"]}),e.jsx("div",{className:"ml-8 space-y-2 text-sm text-gray-600",children:e.jsxs("p",{children:["Go to"," ",e.jsxs("a",{href:"https://console.cloud.google.com/apis/library/gmail.googleapis.com",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline inline-flex items-center gap-1",children:["Gmail API ",e.jsx(m,{className:"w-3 h-3"})]})," ",'and click "Enable".']})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx("span",{className:"w-6 h-6 rounded-full bg-blue-100 text-blue-800 flex items-center justify-center text-sm",children:"3"}),"Configure OAuth Consent Screen"]}),e.jsxs("div",{className:"ml-8 space-y-2 text-sm text-gray-600",children:[e.jsxs("p",{children:["Go to"," ",e.jsxs("a",{href:"https://console.cloud.google.com/apis/credentials/consent",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline inline-flex items-center gap-1",children:["OAuth consent screen ",e.jsx(m,{className:"w-3 h-3"})]})]}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:'Select "External" user type (or Internal if using Google Workspace)'}),e.jsx("li",{children:"Fill in app name and your email"}),e.jsx("li",{children:"Add scopes: gmail.readonly, gmail.labels"}),e.jsx("li",{children:"Add your email as a test user"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx("span",{className:"w-6 h-6 rounded-full bg-blue-100 text-blue-800 flex items-center justify-center text-sm",children:"4"}),"Create OAuth Credentials"]}),e.jsxs("div",{className:"ml-8 space-y-2 text-sm text-gray-600",children:[e.jsxs("p",{children:["Go to"," ",e.jsxs("a",{href:"https://console.cloud.google.com/apis/credentials",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline inline-flex items-center gap-1",children:["Credentials ",e.jsx(m,{className:"w-3 h-3"})]})]}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:'Click "Create Credentials" â†’ "OAuth client ID"'}),e.jsx("li",{children:'Select "Web application"'}),e.jsx("li",{children:"Add the following redirect URI:"})]}),e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-100 rounded mt-2",children:[e.jsx("code",{className:"text-xs flex-1 break-all",children:r}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>M(r),children:e.jsx(se,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"mt-2",children:"Copy the Client ID and Client Secret below."})]})]})]})]}),e.jsxs(p,{className:"mb-6",children:[e.jsxs(j,{children:[e.jsx(f,{children:"OAuth Credentials"}),e.jsx(E,{children:"Enter your Google OAuth credentials from the Cloud Console"})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"clientId",children:"Client ID"}),e.jsx(T,{id:"clientId",placeholder:"xxxx.apps.googleusercontent.com",value:x,onChange:s=>O(s.target.value),type:"text"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"clientSecret",children:"Client Secret"}),e.jsx(T,{id:"clientSecret",placeholder:"GOCSPX-xxxx",value:h,onChange:s=>R(s.target.value),type:"password"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{onClick:U,disabled:w,children:w?"Saving...":"Save Credentials"}),I&&!u&&e.jsxs(d,{variant:"outline",onClick:z,children:[e.jsx(L,{className:"w-4 h-4 mr-2"}),"Connect Gmail"]})]})]})]})]})}export{pe as component};
